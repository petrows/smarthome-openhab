var Timer verlassenTimer = null

rule "Spiegel control SW"
when
    Channel "mqtt:topic:openhab:mirror_remote:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "toggle": {
            if (snf_eg_fl_spiegel.state != ON) {
                snf_eg_fl_spiegel.sendCommand(ON)
            } else {
                snf_eg_fl_spiegel.sendCommand(OFF)
            }
        }
        case "brightness_up_click": {
            var brightness = snf_eg_fl_spiegel_brightness.getState as Number

            brightness = brightness + 30;
            if (brightness > 80) { brightness = 100; }

            snf_eg_fl_spiegel_brightness.sendCommand(brightness)
        }
        case "brightness_down_click": {
            var brightness = snf_eg_fl_spiegel_brightness.getState as Number

            brightness = brightness - 30;
            if (brightness < 10) { brightness = 1; }

            snf_eg_fl_spiegel_brightness.sendCommand(brightness)
        }
        case "arrow_left_click": {
            // g_light_kg.sendCommand(OFF)
        }
        case "arrow_right_click": {
            // g_light_kg.sendCommand(OFF)
        }
    }
end

rule "House verlassen SW"
when
    Channel "mqtt:topic:openhab:eg_leave_switch:action" triggered
then
	var state = receivedEvent

    logWarn("light", "Verlassen SW: " + state)

    verlassenTimer = createTimer(now.plusSeconds(20), [ |
        logWarn("light", "Verlassen all OFF")
        g_light_all.sendCommand(OFF)
    ])

    // Set all except treppe oben
    g_light_all.members.forEach [s |
        if (s == treppe_up_light_sw) {
            // s.sendCommand(ON)
            // Set Ladder lamp ON and 100%
            treppe_up_light_dim.sendCommand(100)
        } else {
            s.sendCommand(OFF)
        }
    ]

    // Diff by buttons
    switch(state) {

        // Someone in house?
        case "on": {
            // Do nothing
        }

        // Nobody in house
        case "off": {
            if (cfgHeatingEnable.state == ON) {
                g_hz_all.sendCommand(cfgHeatingTempOff.state as Number)
            }
        }
    }

end

rule "KG Ladder BOTTOM btn"
when
    Channel "mqtt:topic:openhab:treppe_down_switch:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "on": {
            treppe_manual_sw.sendCommand(ON)
            g_dim_treppe.sendCommand(100)
        }
        case "off": {
            g_light_treppe.sendCommand(OFF)
            g_light_lager_auto.sendCommand(OFF) // Lager licht also OFF
            kg_lager1_main_light.sendCommand(OFF)
            kg_lager3_main_light.sendCommand(OFF)
            kg_lager4_main_light.sendCommand(OFF)
        }
        // Left arrow: turn off all light in KG rooms
        case "arrow_left_click": {
            g_light_kg_hobbyraum.sendCommand(OFF)
        }
        // Right arrow: turn on desktop (+pc)
        case "arrow_right_click": {
            desktop_petro_power_try.sendCommand(ON)
            g_light_kg_desktop_dim.sendCommand(25)
            desktop_petro_light_dim.sendCommand(100)
        }
        // Turn OFF EG light
        case "brightness_move_down": { // Long press DOWN
            g_light_eg.sendCommand(OFF)
        }
    }
end

rule "KG Ladder UP btn"
when
    Channel "mqtt:topic:openhab:treppe_up_switch:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "brightness_move_up": { // Long press UP
            g_light_kg_auto.sendCommand(ON)
            treppe_manual_sw.sendCommand(ON)
            g_dim_treppe.sendCommand(100) // Full brightness for auto-light
        }
        // Turn OFF EG light
        case "brightness_move_down": { // Long press DOWN
            g_light_eg.sendCommand(OFF)
        }
        case "on": {
            treppe_manual_sw.sendCommand(ON)
            g_dim_treppe.sendCommand(100)
        }
        case "off": {
            // Up button switches ALL light in KG
            g_light_kg.sendCommand(OFF)
            // Check that PC is off and turn off also sockets there
            desktop_petro_power_try.sendCommand(OFF)
        }
    }
end

rule "KG Lager corridor btn"
when
    Channel "mqtt:topic:openhab:kg_lager4_switch:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "on": {
            kg_lager4_manual_sw.sendCommand(ON)
            sendCommand(g_dim_lager_auto, 100)
        }
        case "off": {
            sendCommand(g_light_lager_auto, OFF)
            sendCommand(kg_lager1_main_light, OFF)
            sendCommand(kg_lager3_main_light, OFF)
            sendCommand(kg_lager4_main_light, OFF)
        }
    }
end

rule "Petro desktop remote"
when
    Channel "mqtt:topic:openhab:desktop_petro_remote:action" triggered
then
	var state = receivedEvent

    // any evebt turs on table power
    desktop_petro_power_try.sendCommand(ON)

    switch(state) {
        case "toggle": {
            if (g_light_kg_desktop.state == ON) {
                g_light_kg_desktop.sendCommand(OFF)
            } else {
                g_light_kg_desktop.sendCommand(ON)
            }
        }
        case "arrow_right_click": {
            g_light_kg_desktop_dim.sendCommand(100)
            desktop_petro_light_dim.sendCommand(100)
        }
        case "arrow_left_click": {
            g_light_kg_desktop_dim.sendCommand(25)
            desktop_petro_light_dim.sendCommand(100)
        }
        case "brightness_down_click": {
            g_light_kg.members.forEach [s |
                if (
                    s != desktop_petro_light_sw
                    && s != desktop_petro_up_light_1_sw
                    && s != desktop_petro_up_light_2_sw
                    && s != desktop_petro_up_light_3_sw
                ) {
                    s.sendCommand(OFF)
                }
            ]
        }
        case "brightness_up_click": {
            g_light_kg_auto.members.forEach [s |
                if (s != desktop_petro_light_sw) {
                    s.sendCommand(ON)
                }
            ]
        }
    }
end

rule "Marina desktop remote"
when
    Channel "mqtt:topic:openhab:desktop_marina_remote:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "toggle": {
            if (desktop_marina_light_sw.state == ON) { desktop_marina_light_sw.sendCommand(OFF) } else { desktop_marina_light_sw.sendCommand(ON) }
        }
        case "arrow_right_click": {
            desktop_marina_light_dim.sendCommand(100)
        }
        case "arrow_left_click": {
            desktop_marina_light_dim.sendCommand(1)
        }
        case "brightness_down_click": {
            snf_eg_fs.sendCommand(OFF)
        }
        case "brightness_up_click": {
            snf_eg_fs.sendCommand(ON)
        }
    }
end

rule "SZ remote sw (main)"
when
    Channel "mqtt:topic:openhab:sz_remote_main:action" triggered
then
	var state = receivedEvent
    var curtainPos = 0
    try {
        curtainPos = Integer::parseInt(sz_curtain_switch.state.toString())
    } catch(Throwable t) {}
    switch(state) {
        case "on": {
            if (sz_main_light_sw.state == ON && sz_main_light_dim.state > 50) {
                sz_main_light_sw.sendCommand(OFF)
            } else {
                //sz_main_light_sw.sendCommand(ON)
                sz_main_light_dim.sendCommand(100)
            }
        }
        case "off": {
            if (sz_main_light_sw.state == ON && sz_main_light_dim.state < 50) {
                sz_main_light_sw.sendCommand(OFF)
            } else {
                //sz_main_light_sw.sendCommand(ON)
                sz_main_light_dim.sendCommand(1)
            }
        }
        case "arrow_right_click": {
            g_light_eg_sz.sendCommand(OFF)
        }
        case "arrow_left_click": {
            //sz_bed_light.sendCommand(ON)
            sz_bed_light_dim.sendCommand(30)
        }
        case "arrow_left_hold": {
            if (100 != curtainPos) {
                sz_curtain_switch.sendCommand("close")
            }
            //sz_bed_light.sendCommand(ON)
            sz_bed_light_dim.sendCommand(50)
            Thread::sleep(3000)
            g_light_eg_flur.sendCommand(OFF)
            sz_main_light_sw.sendCommand(OFF)
        }
    }
end

rule "SZ remote dimmer (main)"
when
    Item sz_remote_main_dim received update
then
    if (sz_main_light_sw.state == ON) {
        sz_main_light_dim.sendCommand((newState as Number).intValue())
    }
end

rule "SZ remote sw (bed)"
when
    Channel "mqtt:topic:openhab:sz_remote_bed:action" triggered
then
	var state = receivedEvent
    var mode = sz_remote_mode.state.toString()
    switch(state) {
        case "toggle": {
            g_light_all.sendCommand(OFF)
        }
        case "brightness_down_click": {
            if ("DECOR" == mode) {
                g_light_eg_sz_decor_brightness.sendCommand(1)
            }
            if ("BED" == mode) {
                sz_bed_light_dim.sendCommand(1)
            }
        }
        case "brightness_up_click": {
            if ("DECOR" == mode) {
                g_light_eg_sz_decor_brightness.sendCommand(100)
            }
            if ("BED" == mode) {
                sz_bed_light_dim.sendCommand(100)
            }
        }
        case "arrow_right_click": {
            sz_remote_mode.sendCommand("DECOR")
            if (ON == g_light_eg_sz_decor.state) {
                g_light_eg_sz_decor.sendCommand(OFF)
            } else {
                g_light_eg_sz_decor_brightness.sendCommand(1)
            }
        }
        case "arrow_left_click": {
            sz_remote_mode.sendCommand("BED")
            if (ON == sz_bed_light.state) {
                sz_bed_light.sendCommand(OFF)
            } else {
                sz_bed_light_dim.sendCommand(1)
            }
        }
    }
end

rule "SZ remote curtain"
when
    Channel "mqtt:topic:openhab:sz_curtain_remote:action" triggered
then
	var state = receivedEvent
    sz_curtain_switch.sendCommand(state)
end

rule "KU Arbeitlicht SW (Spule)"
when
    Channel "mqtt:topic:openhab:ku_light_switch_spule:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "single": {
            if (ku_light_switch_arbeit_sw.state == ON) {
                ku_light_switch_arbeit_sw.sendCommand(OFF)
            } else {
                ku_light_switch_arbeit_sw.sendCommand(ON)
            }
        }
        case "hold": {
            if (ku_light_switch_haupt_sw.state == ON) {
                ku_light_switch_haupt_sw.sendCommand(OFF)
            } else {
                ku_light_switch_haupt_sw.sendCommand(ON)
            }
        }
    }
end

rule "KU Arbeitlicht SW (Kochfeld)"
when
    Channel "mqtt:topic:openhab:ku_light_switch_kochfeld:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "toggle": {
            if (ku_light_switch_arbeit_sw.state == ON) {
                ku_light_switch_arbeit_sw.sendCommand(OFF)
            } else {
                ku_light_switch_arbeit_sw.sendCommand(ON)
            }
        }
        case "brightness_up_click": {
            ku_light_switch_haupt_sw.sendCommand(ON)
        }
        case "brightness_down_click": {
            ku_light_switch_haupt_sw.sendCommand(OFF)
        }
    }
end


rule "KU table dimmer"
when
    Item ku_light_table_switch_dim received update
then
    if (ku_light_table_sw.state == ON) {
        ku_light_table_dim.sendCommand((newState as Number).intValue())
    }
end

rule "KU table switch"
when
    Channel "mqtt:topic:openhab:ku_light_table_switch:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "on": {
            ku_light_table_sw.sendCommand(ON)
        }
        case "off": {
            ku_light_table_sw.sendCommand(OFF)
        }
        case "arrow_left_click": {
            if (balkon_light.state == OFF) {
                balkon_light.sendCommand(ON)
                balkon_light_dim.sendCommand(100)
            } else {
                balkon_light.sendCommand(OFF)
            }
        }
        case "arrow_right_click": {
            if (g_light_eg_ku_main.state == OFF) {
                ku_light_switch_haupt_sw.sendCommand(ON)
            } else {
                g_light_eg_ku_main.sendCommand(OFF)
            }
        }
    }
end


rule "Garten wasser remote"
when
    Channel "mqtt:topic:openhab:garten_wasser_remote:action" triggered
then
	var state = receivedEvent
    switch(state) {
        case "on": {
            garten_wasser_sw.sendCommand(ON)
        }
        case "off": {
            garten_wasser_sw.sendCommand(OFF)
        }
    }
end

// BZ: Mirror switch

rule "BZ mirror switch"
when
    Channel "mqtt:topic:openhab:bz_mirror_switch:action" triggered
then
    var state = receivedEvent
    switch(state) {
        case "on": {
            bz_mirror.sendCommand(ON)
        }
        case "brightness_move_up": {
            bz_main_light.sendCommand(ON)
            g_light_bz_dim.sendCommand(100)
        }
        case "off": {
            bz_mirror.sendCommand(OFF)
        }
        case "brightness_move_down": {
            bz_main_light.sendCommand(OFF)
        }
    }
end

// BZ Main control button

// Livarno Home LED ceiling light
// requires to be explicitly ON, otherwise brightness command does not set proper state

rule "BZ main switch"
when
    Channel "mqtt:topic:openhab:bz_light_switch:action" triggered
then
    var state = receivedEvent
    switch(state) {
        case "on": {
            // "up" -> Full power
            if (bz_main_light.state == ON && g_light_bz_dim.state > 50) {
                bz_main_light.sendCommand(OFF)
            } else {
                // bz_main_light.sendCommand(ON)
                g_light_bz_dim.sendCommand(100)
            }
        }
        case "off": {
            // "down" -> Small power + only toilet light
            if (bz_light_1_sw.state == ON && bz_light_2_sw.state == OFF && bz_light_1_dim.state < 50) {
                bz_main_light.sendCommand(OFF)
            } else {
                //bz_light_1_sw.sendCommand(ON)
                bz_light_1_dim.sendCommand(1)
                if (bz_light_2_sw.state == ON) {
                    bz_light_2_sw.sendCommand(OFF)
                }
            }
        }
        case "arrow_left_click": {
            if (bz_mirror.state == ON) {
                bz_mirror.sendCommand(OFF)
            } else {
                bz_mirror.sendCommand(ON)
            }
        }
        case "arrow_right_click": {
            g_light_eg_bz.sendCommand(OFF)
        }
    }
end

rule "BZ main dimmer"
when
    Item bz_light_switch_dim received update
then
    // Wake up lights (if not running)
    if (bz_main_light.state == OFF) {
        bz_main_light.sendCommand(ON)
    }
    // Apply brightness state
    g_light_bz_dim.sendCommand((newState as Number).intValue())
end
